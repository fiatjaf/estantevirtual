<!doctype html>
<title>busca m√∫ltipla na estante virtual</title>
<style>
table {
  border: 1px solid black;
  border-collapse: collapse;
}
td:last-child {
  padding-left: 18px;
}
.s1 { color: green }
.s2 { color: red }
.s3 { color: blue }
.s4 { color: grey }
.s5 { color: orange }
</style>

<body>
  <div>
    <input name=s1>
    <input name=s2>
    <input name=s3>
    <input name=s4>
    <input name=s5>
  </div>
  <div id=results>
  </div>
</body>

<script src="https://cdn.rawgit.com/fat/bean/0cc7083a8986ca5be15aed721a36579c3adece69/bean.min.js"></script>
<script src="https://cdn.rawgit.com/snabbdom/snabbdom/3e3acfcc54853a69890ddd917196dabc5028c215/dist/snabbdom.min.js"></script>
<script src="https://cdn.rawgit.com/snabbdom/snabbdom/3e3acfcc54853a69890ddd917196dabc5028c215/dist/h.min.js"></script>
<script src="https://cdn.rawgit.com/snabbdom/snabbdom/3e3acfcc54853a69890ddd917196dabc5028c215/dist/snabbdom_style.min.js"></script>
<script src="https://cdn.rawgit.com/snabbdom/snabbdom/3e3acfcc54853a69890ddd917196dabc5028c215/dist/snabbdom_props.min.js"></script>
<script>
var wait = {}
bean.on(document.body, 'input', 'input', function (e) {
  clearTimeout(wait[e.target.name])
  wait[e.target.name] = setTimeout(fetchResults.bind(null, e.target.name, e.target.value), 2000)
})

var state = {
  stores: {s1: {}, s2: {}, s3: {}, s4: {}, s5: {}}
}

function fetchResults (name, query) {
  var xhr = new XMLHttpRequest()
  xhr.open('GET', '/search?q=' + query.replace(/ /g, '+'))
  xhr.onreadystatechange = function () {
    if (xhr.readyState !== 4) return
    handleResults(name, JSON.parse(xhr.responseText))
  }
  xhr.send()
}

function handleResults (name, results) {
  results.forEach(function (store) {
    state.stores[name][store.url] = store
  })

  renderState()
}

var patch = snabbdom.init([snabbdom_props, snabbdom_style])
var container = document.getElementById('results')
var currentvnode = document.createElement('div')
container.appendChild(currentvnode)

function renderState () {
  var storemap = {}
  for (var s in state.stores) {
    for (var url in state.stores[s]) {
      var books = state.stores[s][url].books
        .map(function (book) {
          book.s = s
          return book
        })

      if (storemap[url]) {
        storemap[url].books = storemap[url].books.concat(books)
      } else {
        storemap[url] = state.stores[s][url]
        storemap[url].books = books
      }
    }
  }

  var storelist = Object.keys(storemap)
    .map(function (url) { return storemap[url] })
    .map(function (store) {
      store.books = store.books
        .sort(function (a, b) { return b.title > a.title ? 1 : -1 })
      return store
    })
    .sort(function (a, b) { return b.books.length - a.books.length })

  var newvnode = h('ul',
    storelist.map(function (store) {
      return h('li', [
        h('a', {props: {href: store.url, target: '_blank'}}, store.name),
        ' -- ',
        h('span', store.place),
        h('table',
          store.books.map(function (book) {
            return h('tr', {props: {className: book.s}}, [
              h('td', book.title),
              h('td', book.author),
              h('td', [
                h('a', {props: {href: book.url, target: '_blank'}}, book.price)
              ])
            ])
          })
        )
      ])
    })
  )
  currentvnode = patch(currentvnode, newvnode)
}
</script>
